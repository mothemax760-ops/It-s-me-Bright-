<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Profil ‚Äî Bright Tup Up</title>
<style>
  body {
    background: radial-gradient(circle at top left, #000 40%, #001a33 100%);
    color: #e0f7ff;
    font-family: "Poppins", sans-serif;
    text-align:center;
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
  }
  .profile-box {
    width:90%; max-width:420px;
    background:rgba(5,10,20,0.95);
    padding:25px;
    border-radius:12px;
    box-shadow:0 0 25px #00aaff, inset 0 0 15px #003355;
    border:1px solid #00aaff;
  }
  #profile-pic {
    width:120px; height:120px;
    border-radius:50%;
    border:3px solid #00ccff;
    object-fit:cover;
    box-shadow:0 0 15px #00aaff;
    margin-bottom:15px;
  }
  h2 { color:#00ccff; margin:10px 0; text-shadow:0 0 15px #00aaff; }
  h3 { color:#00aaff; }
  p { margin:5px 0; }
  .highlight { color:#00aaff; font-weight:bold; }
  .yellow { color:yellow; font-size:18px; }
  button {
    padding:12px 20px;
    border:none; border-radius:10px;
    cursor:pointer; font-weight:bold;
    margin-top:10px;
    background:linear-gradient(90deg,#00aaff,#004466);
    color:#000;
    box-shadow:0 0 12px #00aaff;
    text-transform:uppercase;
  }
  button:hover {
    background:linear-gradient(90deg,#33bbff,#006699);
    box-shadow:0 0 20px #33bbff;
  }
  .red { background:red; color:white; }
</style>
</head>
<body>

<div class="profile-box">
  <img id="profile-pic" src="https://via.placeholder.com/120" alt="Photo de profil"><br>
  <h2 id="username">Utilisateur</h2>
  <h3 id="dp-id"></h3>
  <p id="email"></p>
  <p>R√¥le : <span id="role" class="highlight"></span></p>
  <p class="yellow">üí∞ Solde : <span id="credits">0</span> cr√©dits</p>
  <p>Derni√®re connexion : <span id="lastLogin"></span></p>

  <button onclick="logout()">‚ùå D√©connexion</button>
  <br>
  <button onclick="location.href='produits.html'">üõí Produits</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCbQGaaTjyTxZTWNwRE5lTVkZsZbJyofgg",
  authDomain: "brighttupup.firebaseapp.com",
  projectId: "brighttupup",
  storageBucket: "brighttupup.appspot.com",
  messagingSenderId: "812394183947",
  appId: "1:812394183947:web:d65d60d6aeee39bcc3b60e"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// V√©rifier l'√©tat de connexion Firebase
onAuthStateChanged(auth, async (user) => {
  if (user) {
    // Utilisateur connect√©
    let account = {
      email: user.email,
      username: user.displayName || "Utilisateur",
      photo: user.photoURL || "https://via.placeholder.com/120",
      role: "user",
      credits: 0,
      lastLogin: new Date().toLocaleString()
    };

    // Charger infos Firestore si dispo
    try {
      const usersSnap = await getDocs(collection(db,"users"));
      usersSnap.forEach(docSnap=>{
        const data = docSnap.data();
        if(data.email && data.email.toLowerCase() === user.email.toLowerCase()){
          account = {
            email: data.email,
            username: data.username ?? account.username,
            dp: data.dp ?? "‚Äî",
            role: data.role ?? "user",
            credits: Number(data.credits ?? 0),
            photo: data.photo ?? account.photo,
            lastLogin: data.lastLogin ?? account.lastLogin
          };
        }
      });
    } catch(e){
      console.warn("Erreur Firestore:", e);
    }

    // Sauvegarde session
    sessionStorage.setItem("dpstore_user", JSON.stringify(account));

    // Affichage
    document.getElementById("username").textContent = account.username;
    document.getElementById("email").textContent = account.email;
    document.getElementById("dp-id").textContent = account.dp || "";
    document.getElementById("credits").textContent = account.credits;
    document.getElementById("lastLogin").textContent = account.lastLogin;
    document.getElementById("role").textContent = 
      account.role === "creator" ? "Cr√©ateur" :
      account.role === "employee" ? "Employ√©" :
      account.role === "admin" ? "Administrateur" : "Utilisateur";
    document.getElementById("profile-pic").src = account.photo;
  } else {
    // Pas connect√© ‚Üí retour √† index
    location.href = "index.html";
  }
});

// D√©connexion
function logout(){
  signOut(auth).then(()=>{
    sessionStorage.removeItem("dpstore_user");
    location.href = "index.html";
  });
}
window.logout = logout;
</script>

</body>
</html>
